name: Flutter Matrix Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  test-matrix:
    name: Test on Flutter ${{ matrix.flutter-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        flutter-version: ['3.22.0', '3.24.0', 'stable']
        exclude:
          # Exclude Windows for now due to build complexity
          - os: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java (Ubuntu/macOS)
      if: runner.os != 'Windows'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ matrix.flutter-version }}
        channel: ${{ matrix.flutter-version == 'stable' && 'stable' || 'stable' }}
        cache: true
        
    - name: Create .env file
      shell: bash
      run: |
        echo "SUPABASE_URL=https://example.supabase.co" >> .env
        echo "SUPABASE_ANON_KEY=test-key" >> .env
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Verify formatting
      run: dart format --output=none --set-exit-if-changed .
      
    - name: Analyze project source
      run: flutter analyze --fatal-infos
      
    - name: Run tests
      run: flutter test
      
    - name: Test build (Android)
      if: runner.os == 'Linux'
      run: flutter build apk --debug
      
    - name: Test build (iOS)
      if: runner.os == 'macOS'
      run: |
        cd ios && pod install && cd ..
        flutter build ios --debug --no-codesign
        
  compatibility-report:
    name: Generate Compatibility Report
    runs-on: ubuntu-latest
    needs: test-matrix
    if: always()
    
    steps:
    - name: Create compatibility report
      run: |
        echo "# Flutter Compatibility Report" > compatibility-report.md
        echo "" >> compatibility-report.md
        echo "Generated on: $(date)" >> compatibility-report.md
        echo "" >> compatibility-report.md
        echo "## Test Results" >> compatibility-report.md
        echo "- Matrix testing completed" >> compatibility-report.md
        echo "- Check individual job results for details" >> compatibility-report.md
        
    - name: Upload compatibility report
      uses: actions/upload-artifact@v4
      with:
        name: compatibility-report
        path: compatibility-report.md
        retention-days: 30